" vim: set filetype=vim foldmethod=marker foldlevel=1 et:

" Run Pathogen. Always has to be run first.
call pathogen#infect()
call pathogen#helptags()

" Set leader to comma
let mapleader = ","

" Generic settings {{{
set encoding=utf-8
set mouse=a
" }}}

" Indenting and wrapping {{{
set tabstop=4
set shiftwidth=4
set nosmartindent " As smartindent conflicts with filetype
set nocindent
set smarttab
set expandtab
set shiftround

set ignorecase smartcase
set nowrap " We just CODE to the correct width, bitches!
set whichwrap+=<,>,h,l
set linebreak
set showbreak=~\ \ \ 

set backspace=indent,eol,start

set cursorline
nnoremap <leader>c :set cursorline!<CR>
nnoremap <leader>C :set cursorcolumn!<CR>
" }}}

" UI, mostly {{{
set number " We'll default to this. <Leader>nn switches to relativenumber
set ruler
set cmdheight=3 " Give us some room for feedback. Prevents 90% of 'Press enter
                " to continue'.
set showcmd
set showmode
set scrolloff=2
set novisualbell
set noerrorbells
set hidden

" Prevent Vim from clobbering the scrollback buffer. See
" http://www.shallowsky.com/linux/noaltscreen.html
set t_ti= t_te=
" }}}

" Wildmenu {{{
set wildmenu
set wildmode=list:longest
set wildignore+=.hg,.git,.svn
set wildignore+=.DS_Store,.AppleDouble
set wildignore+=.pyc
set wildignore+=.swp
" }}}

" Split stuff
set equalalways
set eadirection=hor
set splitright

" Resize windows on metawindow resize
augroup Resize
  autocmd!
  autocmd VimResized * exe "normal! \<c-w>="
augroup END

" For browser weenies
" nnoremap <space> 
" nnoremap <S-space> 

" For everyone who uses wrap
nnoremap j gj
nnoremap k gk

" Keep visual selection after indenting
" vnoremap < <gv
" vnoremap > >gv

" Write with sudo
cnoremap w!! w !sudo tee % >/dev/null

" Paste with auto-indent
nnoremap <Leader>p p'[v']=
nnoremap <Leader>P P'[v']=
nnoremap <Leader>pp :set paste!<CR>

" Set title
set title
set titlestring=%t%(\ %M%)%(\ (%{expand(\"%:~:.:h\")})%)%(\ %a%)

" Folding
set foldmethod=indent
set foldlevel=100

" Highlighting search
set showmatch
set matchpairs+=<:>
set hlsearch
set incsearch

nnoremap <leader>n :nohlsearch<CR> " Setting it to enter mucked with error windows.
noremap <leader>h :let @/ = ""<CR> " clear search pattern to disable hlsearch
" Syntax stuff
filetype plugin indent on
syntax enable
" noremap <leader>s :syntax enable<CR>
noremap <leader>hi :so $VIMRUNTIME/syntax/hitest.vim<CR>

" PURDY COLORZ
let g:CSApprox_verbose_level = 0
set bg=dark
" colorscheme molokai
"colorscheme mustang
"colorscheme wombat256
colorscheme xoria256
" map <silent><F2> :PREVCOLOR<CR>
" map <silent><F3> :NEXTCOLOR<CR>

hi CursorLine ctermbg=238 cterm=NONE " Disable underline which cterm doesn't need.

if has("gui_running")
  set guioptions-=T " No toolbar
  set guioptions-=r " No right scrollbar
  set guioptions-=L " No left scrollbar
  set guioptions+=g " Grey menu items instead of hiding them
  set guioptions+=i " Icons are nifty
  set guitablabel=%M%t
  " hi SpecialKey guifg=#444444
  " hi NonText guifg=#444444 guibg=bg
  " hi VertSplit guifg=#000000 guibg=#000000
  " hi Todo gui=undercurl
endif

" A nice EOL guide column. {{{
if exists("&colorcolumn")
  set colorcolumn=80
  hi ColorColumn ctermbg=237 guibg=#232526
endif
" }}}

" Netrw stuff {{{
let g:netrw_liststyle=1 " long listing
" let g:netrw_browse_split = 4
let g:netrw_silent=1 " We don't need to hear about transfers
let g:netrw_alto=1 " open o-splits at the bottom
let g:netrw_altv=1 " open v-splits to the right
let g:netrw_list_hide='\.pyc,^\..*'
let g:netrw_sort_sequence='[\/]$,TODO$,INSTALLATION$,README$,\<core\%(\.\d\+\)\=\>,^\.,\.h$,\.c$,\.cpp$,\.php$,\.py$,\.html$,*,\.o$,\.obj$,\.txt$,\.info$,\.swp$,\.bak$,\.pyc$,\~$,\.[dmg|xcf|jpg|png]$'
let g:explHideFiles='^\.,.*\.pyc$,.svn'
" let g:netrw_winsize = 35
" let g:netrw_preview = 1
" }}}

if has('gui_macvim')
  behave xterm
  set selectmode=
  set keymodel=
  set mousemodel=popup_setpos
  " set noantialias
  " set gfn=EnvyCodeR:h13
  set gfn=Anonymous\ Pro\ for\ Powerline:h15
  " set gfn=Inconsolata-dz:h12
  let macvim_skip_cmd_opt_movement = 1
  let macvim_hig_shift_movement = 1
  let g:netrw_browsex_viewer='open'
  map <S-D-[> :tabprevious<CR>
  map <S-D-]> :tabnext<CR>
  set linespace=3

  set fuoptions=maxvert,maxhorz,background:Normal " Fullscreen options

  " let g:netrw_ctags='/opt/local/bin/ctags'
  " let Tlist_Ctags_Cmd='/opt/local/bin/ctags'
else
  " let g:netrw_ctags='/usr/bin/ctags'
  " let Tlist_Ctags_Cmd='/usr/bin/ctags'
endif

set textwidth=80
set formatoptions=lcqn " see :help fo-table for letter meaning

" BACKUP AND UNDO STUFF {{{

" Directories that have // at the end will be expanded to the full file path
" See: http://stackoverflow.com/questions/4331776/change-vim-swap-backup-undo-file-name/4331812#4331812

" Move temporary files to ~/.vimtmp/ instead of current dir
if ! isdirectory(expand('~/.vimtmp'))
   call mkdir(expand('~/.vimtmp'))
endif
if isdirectory(expand('~/.vimtmp'))
   set directory=~/.vimtmp//
else
   set directory=.,/var/tmp//,/tmp//
endif

" Save tons of history and undo (Thanks, Arnout)
set history=10000
set undolevels=10000

" Set persistent undo, only works on >73
if exists("&undodir") && exists("&undofile")
  " Setup persistently store the undo folder
  if ! isdirectory(expand('~/.vimundo'))
    call mkdir(expand('~/.vimundo'))
  endif
  set undodir=~/.vimundo
  set undofile
endif

set backupskip=/tmp/*,/private/tmp/*" 
if ! isdirectory(expand('~/.vimbackup'))
  call mkdir(expand('~/.vimbackup'))
endif
set backupdir=~/.vimbackup//
" set backup

" Disable swapsync. While this might, theoretically, cause us to lose up to 30
" seconds of data, calling fsync() sometimes causes lag.
set swapsync=

" }}}

" {{{ Filetypes
augroup Filetypes
  autocmd!
  autocmd BufRead,BufNewFile *.smarty setlocal ft=smarty.html
  autocmd BufRead,BufNewFile,BufEnter *.json setlocal ft=javascript
  autocmd BufRead,BufNewFile,BufEnter *.ejs setlocal ft=javascript
  autocmd BufRead,BufNewFile,BufEnter *.md setlocal ft=markdown
  autocmd BufRead,BufNewFile,BufEnter *.tt2 set ft=tt2html
  autocmd BufRead,BufNewFile,BufEnter .tmux.conf*,tmux.conf* set ft=tmux
  autocmd FileType markdown setlocal tabstop=2 shiftwidth=2 showbreak= nonumber " formatoptions+=t
  autocmd FileType html setlocal indentkeys-=*<Return> " Stop reformatting after newline
augroup END
" }}}

" Editing the .vimrc file {{{
" From http://github.com/devjj/vim-config/blob/master/.vimrc After editing, run
augroup Vimrc
  autocmd!
  autocmd BufWritePost $MYVIMRC source $MYVIMRC | call Pl#ReloadColorscheme() | exec 'echom "vimrc reloaded after save."'
  " Setting keywordprg to blank leads to vim using :help instead.
  autocmd FileType vim setlocal keywordprg= ts=2 sw=2
augroup END

noremap <leader>vv :vsplit $MYVIMRC<CR>
noremap <leader>V :source $MYVIMRC<CR>:filetype detect<CR>:echom 'vimrc reloaded'<CR>
" }}}

" Snippets {{{
let g:snippets_dir="~/.vim/my_snips/"
let g:snips_author="Max Roeleveld"
let g:snips_company="Hotels.nl"
" autocmd bufwritepost snippet :call ReloadSnippets(snippets_dir, &filetype)<CR>
" }}}

" Allow me to switch between number and relativenumber. Vim >= 7.3
function! SwitchNumbering()
  if exists("&relativenumber")
    if &number && ! &relativenumber
      set relativenumber
    elseif ! &number && &relativenumber
      set number
    endif
  else
    echo "Your VIM doesn't support relativenumber!"
  endif
endfunction
nnoremap <leader>nn :call SwitchNumbering()<CR>

" Invisible characters {{{
set listchars=trail:·,tab:‣‒,eol:¬,extends:«,precedes:»
set nolist
noremap <leader>i :set list!<CR> " Toggle invisible chars"
" }}}

noremap <leader>cd :cd %:p:h<CR>

" PHP stuff {{{
" Disable auto-php-folding if PIV is plugged in
augroup php
  autocmd!
  autocmd FileType php setlocal keywordprg=pman colorcolumn=80 textwidth=100
augroup END

let g:DisableAutoPHPFolding=1
let g:PHP_vintage_case_default_indent = 1
let php_noShortTags=0
let php_sql_query=0
let php_htmlInStrings=0
let php_folding=0
let PHP_outdentphpescape=0
" }}}

augroup python
  " http://www.sontek.net/Python-with-a-modular-IDE-(Vim)
  autocmd!
  autocmd FileType python set omnifunc=pythoncomplete#Complete
  autocmd FileType python setlocal keywordprg=pman colorcolumn=80 textwidth=80
  autocmd BufRead *.py set makeprg=python\ -c\ \"import\ py_compile,sys;\ sys.stderr=sys.stdout;\ py_compile.compile(r'%')\" 
  autocmd BufRead *.py set efm=%C\ %.%#,%A\ \ File\ \"%f\"\\,\ line\ %l%.%#,%Z%[%^\ ]%\\@=%m 
augroup END

set suffixes=.bak,~,.o,.h,.info,.swp,.obj,.pyc,.pyo

set tags=./tags,tags

" Fugitive {{{
augroup fugitive
  autocmd!
  autocmd BufReadPost fugitive://* setlocal bufhidden=delete " Kill git buffs on close
augroup END
" }}}

" TagList {{{
noremap <leader>t :TlistToggle<CR>
let Tlist_Sort_Type="order"
let Tlist_Use_SingleClick=1
let Tlist_Show_Menu=1
let Tlist_Exit_OnlyWindow=1
let Tlist_Enable_Fold_Column=1
let Tlist_Close_On_Select=0
let Tlist_Use_Right_Window=0
let Tlist_Process_File_Always=1
let Tlist_Show_One_File=1
let Tlist_Display_Prototype=1
let Tlist_Max_Submenu_Items=50
let Tlist_Max_Tag_Length=50

" Disable that slow stuff for now, it really chokes a bitch on larger minified
" javascript files:
let Tlist_javascript_Ctags_Cmd='ctags'
" }}}


" Syntastic {{{
" let g:syntastic_mode_map={ 'mode': 'passive',
"                            \ 'active_filetypes': [],
"                            \ 'passive_filetypes': ['html', 'html.php'] }
let g:syntastic_check_on_open=0
" let g:syntastic_enable_signs=1
" let g:syntastic_enable_balloons=1
" let g:syntastic_enable_highlighting=1
" let g:syntastic_echo_current_error=0
" let g:syntastic_stl_format = '[%E{Err:%e}%B{, }%W{Warn:%w}]'
let g:syntastic_auto_loc_list=0
let g:syntastic_php_checkers=['php', 'phpcs']
" let g:syntastic_php_phpcs_args="--standard=Hotelsnl --tab-width=2 --ignore=*/templates/*"
let g:syntastic_javascript_checkers=['phpcs', 'jshint']
let g:syntastic_error_symbol='✗'
let g:syntastic_style_error_symbol='✗'
let g:syntastic_warning_symbol='⚠'
let g:syntastic_style_warning_symbol='⚠'

noremap <leader>st :SyntasticToggleMode<CR>
noremap <leader>sc :SyntasticCheck<CR>
noremap <leader>se :Errors<CR>
" }}}


" MiniBufExplorer -- currently not used
let g:miniBufExplMapWindowNavVim = 1 
let g:miniBufExplMapWindowNavArrows = 1 
let g:miniBufExplModSelTarget = 1 
let g:miniBufExplUseSingleClick = 1
let g:miniBufExplMapCTabSwitchBufs = 1

" Stop the beeping AND flashing
set vb t_vb=".

" Bigger redraw
set ttyfast

" Re-select text you just pasted so you can indent it and stuff
nnoremap <leader>q gqip

" Cycling between buffers
noremap <C-Tab> :bn<CR>
noremap <S-C-Tab> :bp<CR>

" Quick jumping between splits and buffers
noremap <C-J> <C-W>j
noremap <C-K> <C-W>k
noremap <C-H> <C-W>h
noremap <C-L> <C-W>l
" noremap <S-C-H> :bp<CR>
" noremap <S-C-L> :bn<CR>
noremap <silent><A-Right> :bnext!<CR> 
noremap <silent>O5C :bnext!<CR> 
noremap <silent><A-Left> :bprevious!<CR> 
noremap <silent>O5D :bprevious!<CR> 

" Why didn't I think of these earlier?
inoremap <C-E> <End>
inoremap <C-A> <Home>
nnoremap 0 ^

" Uppercase / lowercase current word
nnoremap <Leader>U viwU
nnoremap <Leader>u viwu

" Remap num island to proper numbers
:inoremap <Esc>Oq 1
:inoremap <Esc>Or 2
:inoremap <Esc>Os 3
:inoremap <Esc>Ot 4
:inoremap <Esc>Ou 5
:inoremap <Esc>Ov 6
:inoremap <Esc>Ow 7
:inoremap <Esc>Ox 8
:inoremap <Esc>Oy 9
:inoremap <Esc>Op 0
:inoremap <Esc>On .
:inoremap <Esc>OQ /
:inoremap <Esc>OR *
:inoremap <Esc>Ol +
:inoremap <Esc>OS -

" If I want help, I'll ask for it (instead of inadvertly hit my F1 when I
" actually wanted ESC)
noremap <F1> <Esc>
inoremap <F1> <Esc>
noremap OP <Esc>
inoremap OP <Esc>

" j is on the home row, Esc isn't, and we don't use j all that much anyway.
" inoremap jj <Esc>
" inoremap JJ <Esc>

" Hey, F5 wasn't used yet. Let's map :make to that!
" noremap <F5> :make<CR>

" Search for diff separater stuff
nnoremap <Leader>fd /^<<<<<<<\\|^=======\\|^>>>>>>><CR>

" NERDCommenter {{{
let g:NERDRemoveExtraSpaces=1
let g:NERDSpaceDelims=1
let g:NERDComInsertMap='<c-c>'
let g:NERDCustomDelimiters = { 'html': { 'left': '<!--', 'right': '-->'}}
" }}}

" WinManager {{{
noremap <c-w><c-b> :BottomExplorerWindow<CR>
noremap <c-w><c-f> :FirstExplorerWindow<CR>
noremap <c-w><c-t> :WMToggle<CR>
let g:winManagerWidth=40
let g:winManagerWindowLayout = "FileExplorer,TagList|BufExplorer"
" }}}

" Gundo {{{
noremap <c-w><c-g> :GundoToggle<CR>
" }}}

" Ctrl-P {{{
let g:ctrlp_use_caching=1
let g:ctrlp_working_path_mode=1
let g:ctrlp_custom_ignore={
  \ 'dir':  '\.git$\|\.hg$\|\.svn$\|\.yardoc\|public\/images\|public\/system\|data\|log\|tmp$',
  \ 'file': '\.exe$\|\.so$\|\.dat$\|.fugitiveblame$'
  \ }
let g:ctrlp_by_filename=1
nnoremap <leader>b :CtrlPBuffer<CR>
nnoremap <leader>m :CtrlPMRUFiles<CR>
nnoremap <leader>cp :CtrlPCurFile<CR>
nnoremap <leader>cr :CtrlPRoot<CR>

let g:Powerline_symbols = 'fancy'
let g:solarized_termcolors=256

" CtrlP buffer list
" if exists("*CtrlPBuffer")
" endif
" }}}

" GitGutter {{{
if exists("*ToggleGitGutter")
  nnoremap <leader>gg :ToggleGitGutter<CR>
  nnoremap <leader>gn :GitGutterNextHunk<CR>
  nnoremap <leader>gp :GitGutterPrevHunk<CR>
endif
" }}}

" Favourites for file-explorer
let g:favDirs='/Volumes/home/git/'."\n"


" Statusline goodness {{{
set laststatus=2
" }}}

" Code defuckination {{{
" Fix commas
vnoremap <Leader>,, :s/, \@!\(.\+\)/, \1/g<CR>

function! FixLeCode()
  " Add surrounding spaces to <=, =>, == etc.
  :%s/\(!\|+\|-\|\.\|=\|<\|>\)\@<!\(=\|==\|===\|=>\|+=\|-=\)\( \|>\|=\)\@!/ \2 /g
  :g/function/s/ = /=/g

  " No line should end in a space, ever
  :%s/\s\+$//g

  " Pull braces to the same line where the funciton started
  :g/^\s*\(\(public\|private\) \)\?function .\+)$/j
endfunction

" Keep some space between if/for/foreach/while and the paren'd part, also keep
" some space between the closing paren and the opening brace
function! FixSpaceBrace()
  :%s/\(if\|elseif\|for\|foreach\|while\)(/\1 (/g
  :%s/){/) {/g
  :%s/function \(\w\+\) (/function \1(/g
endfunction

function! DeEscapeCodify()
  " Removes ANSI escape codes, at least from Javascript
  :%s/\\x1b\[\(\d\+;\)*\d\+m//g
endfunction

" Remove whitespace from code files on save
function! StripTrailingWhite()
  let l:winview = winsaveview()
  silent! %s/\s\+$//
  call winrestview(l:winview)
endfunction
autocmd BufWritePre *.{php,py,pl,js,css,styl,less,html} call StripTrailingWhite()
" }}}

""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
" EXTRACT VARIABLE (SKETCHY
" Stolen from https://github.com/garybernhardt/dotfiles/blob/master/.vimrc
"   but handling PHP was my own idea =]
""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
function! ExtractVariable()
  " Pre-set stuff.
  let eol_marker = ''
  let needs_semicolon = ['php','javascript','perl']
  let needs_dollar = ['php']

  " Get the varname
  let name = input("Variable name: ")
  if name == ''
    return
  endif

  " Some filetypes need a $ in front of their strings
  if &ft == 'php'
    let name = '$' . name
  endif

  " Some filetypes need a ; at the end of their newly created line
  if index(needs_semicolon, &ft) >= 0
    let eol_marker = ';'
  endif

  " Enter visual mode (not sure why this is needed since we're already in
  " visual mode anyway)
  normal! gv

  " Replace selected text with the variable name
  exec "normal c" . name
  " Define the variable on the line above
  exec "normal! O" . name . " = "
  " Paste the original selected text to be the variable value
  normal! $p
  if eol_marker != ''
    exec "normal A" . eol_marker
  endif
endfunction
vnoremap <leader>rv :call ExtractVariable()<cr>

" Hexy tiem
nnoremap <leader>hon :%!xxd<cr>
nnoremap <leader>hof :%!xxd -r<cr>

" Transpose the files in the quickfix list to args, so you can argdo on them.
function! QFtoArgs()
  let x={}
  for d in getqflist()
    let x[bufname(d.bufnr)]=1
  endfor
  exec 'args' join(keys(x))
endfunction
nnoremap <Leader>qa :call QFtoArgs()

" XDebug Remote Debugging {{{
let g:dbgPavimPort = 9000
let g:dbgPavimBreakAtEntry = 1
" }}}

" Faster escape {{{
" Found at https://powerline.readthedocs.org/en/latest/tipstricks.html
set ttimeoutlen=10
augroup FastEscape
  autocmd!
  au InsertEnter * set timeoutlen=0
  au InsertLeave * set timeoutlen=1000
augroup END
" }}}

" Add site-specific stuff. Make sure this is alwyas at the end of .vimrc.
if filereadable(expand("~/.vimlocalrc"))
  source ~/.vimlocalrc
endif
